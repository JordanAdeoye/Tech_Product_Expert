name: CD

on:
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types: [completed]
  workflow_dispatch:

concurrency:
  group: cd-production
  cancel-in-progress: true

jobs:
  deploy: 
    name: Deploy to EC2 Production
    runs-on: ubuntu-latest
    environment: production
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
 
      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.event_name == 'workflow_dispatch' && github.sha || github.event.workflow_run.head_sha }}
          ACTOR: ${{ github.actor }}
        run: |
          ssh -i ~/.ssh/deploy_key $EC2_USERNAME@$EC2_HOST bash -s << 'ENDSSH'
            set -euo pipefail

            echo "=========================================="
            echo "ðŸš€ Starting Deployment to Production"
            echo "=========================================="
            echo "Time: $(date)"
            echo ""

            cd ~/Tech_Product_Expert

            # Safety (optional but good)
            git config --global --add safe.directory "$(pwd)"

            echo "ðŸ“¥ Pulling latest changes from GitHub..."
            git fetch origin
            git reset --hard origin/demo

            cd airflow-docker

            echo "ðŸ“Š Current container status:"
            docker-compose ps || true

            echo "ðŸ›‘ Stopping containers gracefully..."
            docker-compose down --timeout 30

            echo "ðŸ”¨ Building and starting containers..."
            docker-compose up -d --build --force-recreate

            echo "â³ Waiting for services to start..."
            sleep 45

            echo "âœ… Deployment Complete"
            docker-compose ps
          ENDSSH

      - name: Verify Deployment (via domain)
        run: |
          set -e
          echo "ðŸ” Verifying deployment..."
          sleep 15

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://techtalkrag.com || true)
          echo "Domain returned HTTP $HTTP_CODE"

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "âœ… Domain is responding"
          else
            echo "âš ï¸ Domain not healthy yet (HTTP $HTTP_CODE)"
            exit 1
          fi
